// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  DRIVER
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Gender {
  MALE
  FEMALE
}

model User {
  id          String     @id @default(uuid())
  phone       String     @unique // Changed from email to phone as primary identifier
  email       String?    @unique // Email is now optional
  password    String
  role        UserRole
  status      UserStatus @default(ACTIVE)
  birthDate   DateTime? // Tanggal lahir
  gender      Gender? // Jenis kelamin
  lastLoginAt DateTime?
  deletedAt   DateTime? // Soft delete timestamp
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  admin    Admin?
  driver   Driver?
  customer Customer?

  @@index([phone])
  @@index([email])
  @@index([role])
  @@index([deletedAt])
}

model Admin {
  id               String    @id @default(uuid())
  userId           String    @unique
  name             String
  phone            String    @unique
  birthDate        DateTime? // Tanggal lahir
  gender           Gender? // Jenis kelamin
  profileImageUrl  String? // URL foto profil admin
  coinBalance      Int       @default(0) // Saldo coin admin
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime? // Soft delete

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  coinRequests     CoinRequest[] // Request topup dari admin
  coinTransactions CoinTransaction[] // Histori transaksi coin
  ticketBookings   Ticket[] // Tiket yang dibuat oleh admin
  travelDocuments  TravelDocument[] // Surat jalan yang diterbitkan

  @@index([userId])
  @@index([deletedAt])
}

model Customer {
  id               String    @id @default(uuid())
  userId           String    @unique
  name             String
  phone            String    @unique
  address          String?
  birthDate        DateTime? // Tanggal lahir
  gender           Gender? // Jenis kelamin
  profileImageUrl  String? // URL foto profil customer
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tickets       Ticket[]
  paymentProofs PaymentProof[] // Bukti pembayaran yang diupload

  @@index([userId])
  @@index([phone])
  @@index([deletedAt])
}

enum DriverStatus {
  AVAILABLE
  ON_TRIP
  OFF_DUTY
}

model Driver {
  id               String       @id @default(uuid())
  userId           String       @unique
  name             String
  phone            String       @unique
  licenseNumber    String? // Nomor SIM
  address          String?
  birthDate        DateTime? // Tanggal lahir
  gender           Gender? // Jenis kelamin
  profileImageUrl  String? // URL foto profil driver
  status           DriverStatus @default(AVAILABLE)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules Schedule[] // Jadwal yang di-assign ke driver
  tripLogs  TripLog[] // Log perjalanan driver

  @@index([userId])
  @@index([phone])
  @@index([status])
  @@index([deletedAt])
}

// ==================== COIN SYSTEM ====================

enum CoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model CoinRequest {
  id             String            @id @default(uuid())
  adminId        String
  amount         Int // Jumlah coin yang diminta
  status         CoinRequestStatus @default(PENDING)
  notes          String? // Catatan dari admin
  approvedBy     String? // Super admin yang approve
  approvedAt     DateTime?
  rejectedBy     String?
  rejectedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([status])
  @@index([rejectedBy])
  @@index([rejectedAt])
  @@index([createdAt])
}

enum CoinTransactionType {
  TOP_UP // Penambahan coin dari super admin
  DEDUCTION // Pengurangan coin
  REFUND // Pengembalian coin
}

enum CoinTransactionReason {
  TOP_UP_APPROVED // Top up disetujui super admin
  TICKET_BOOKING // Pemesanan tiket (10k per penumpang)
  TRAVEL_DOCUMENT // Penerbitan surat jalan (10k per surat)
  TICKET_CANCELLATION // Refund dari pembatalan tiket
}

model CoinTransaction {
  id            String                @id @default(uuid())
  adminId       String
  type          CoinTransactionType
  reason        CoinTransactionReason
  amount        Int // Positif untuk penambahan, negatif untuk pengurangan
  balanceBefore Int // Saldo sebelum transaksi
  balanceAfter  Int // Saldo setelah transaksi
  referenceId   String? // ID referensi (ticketId, travelDocumentId, coinRequestId)
  referenceType String? // Tipe referensi (ticket, travel_document, coin_request)
  notes         String?
  createdBy     String? // User yang melakukan transaksi
  createdAt     DateTime              @default(now())

  // Relations
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([createdAt])
  @@index([type])
  @@index([referenceId])
}

// ==================== TRAVEL ROUTES & SCHEDULES ====================

model Route {
  id                String   @id @default(uuid())
  routeCode         String   @unique // Contoh: JKT-BDG-001
  origin            String // Kota asal
  destination       String // Kota tujuan
  distance          Float? // Jarak dalam km
  estimatedDuration Int? // Estimasi durasi dalam menit
  basePrice         Int // Harga dasar
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  schedules Schedule[]

  @@index([routeCode])
  @@index([origin, destination])
  @@index([isActive])
}

enum VehicleType {
  EKSEKUTIF
  REGULAR
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

model Vehicle {
  id            String        @id @default(uuid())
  vehicleNumber String        @unique // Nomor plat kendaraan
  type          VehicleType
  brand         String?
  model         String?
  capacity      Int // Kapasitas penumpang
  status        VehicleStatus @default(AVAILABLE)
  imageUrl      String? // URL gambar kendaraan
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  schedules       Schedule[]
  travelDocuments TravelDocument[]

  @@index([vehicleNumber])
  @@index([status])
}

enum ScheduleStatus {
  SCHEDULED
  DEPARTED
  ARRIVED
  CANCELLED
}

model Schedule {
  id             String         @id @default(uuid())
  routeId        String
  vehicleId      String
  driverId       String? // Driver yang di-assign
  departureTime  DateTime
  arrivalTime    DateTime?
  price          Int // Harga tiket untuk jadwal ini
  availableSeats Int // Kursi tersedia
  fuelCost       Int? // Biaya BBM
  driverWage     Int? // Upah sopir
  snackCost      Int? // Biaya snack
  status         ScheduleStatus @default(SCHEDULED)
  cancelledAt    DateTime?
  cancelledBy    String?
  cancelReason   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  route           Route            @relation(fields: [routeId], references: [id], onDelete: Cascade)
  vehicle         Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  driver          Driver?          @relation(fields: [driverId], references: [id], onDelete: SetNull)
  tickets         Ticket[]
  travelDocuments TravelDocument[]
  tripLogs        TripLog[] // Log perjalanan
  paymentProofs   PaymentProof[] // Bukti pembayaran untuk jadwal ini

  @@index([routeId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([departureTime])
  @@index([status])
  @@index([cancelledAt])
}

// ==================== TICKET BOOKING ====================

enum TicketStatus {
  PENDING_PAYMENT // Menunggu upload bukti pembayaran
  PENDING_APPROVAL // Menunggu approval admin
  CONFIRMED // Sudah diapprove admin
  CANCELLED // Dibatalkan
  COMPLETED // Perjalanan selesai
  REFUNDED // Sudah direfund
}

enum BookingSource {
  CUSTOMER_APP // Dari aplikasi customer (Flutter)
  ADMIN_PANEL // Dari admin panel (Next.js)
}

enum PaymentProofStatus {
  PENDING // Menunggu approval admin
  APPROVED // Diapprove admin, tiket dibuat
  REJECTED // Ditolak admin
}

model Ticket {
  id              String        @id @default(uuid())
  ticketNumber    String        @unique // Nomor tiket unik
  scheduleId      String
  customerId      String? // Null jika dipesan oleh admin untuk orang lain
  adminId         String? // Admin yang memproses (jika dari admin panel)
  bookingSource   BookingSource
  bookerPhone     String // Nomor HP pemesan (wajib)
  pickupAddress   String // Alamat jemput (wajib)
  dropoffAddress  String // Alamat antar (wajib)
  totalPassengers Int // Jumlah penumpang
  totalPrice      Int // Total harga
  status          TicketStatus  @default(PENDING_PAYMENT)
  bookingDate     DateTime      @default(now())
  paymentDate     DateTime?
  notes           String?
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelReason    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  schedule     Schedule      @relation(fields: [scheduleId], references: [id], onDelete: Restrict)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  admin        Admin?        @relation(fields: [adminId], references: [id], onDelete: SetNull)
  passengers   Passenger[]
  paymentProof PaymentProof? // Bukti pembayaran yang menghasilkan tiket ini

  @@index([ticketNumber])
  @@index([scheduleId])
  @@index([customerId])
  @@index([adminId])
  @@index([bookerPhone])
  @@index([status])
  @@index([bookingDate])
  @@index([cancelledAt])
  @@index([cancelledBy])
}

model Passenger {
  id             String   @id @default(uuid())
  ticketId       String
  name           String
  identityNumber String? // NIK/KTP/Passport
  phone          String?
  seatNumber     String? // Nomor kursi
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// ==================== PAYMENT PROOF ====================

model PaymentProof {
  id              String             @id @default(uuid())
  proofNumber     String             @unique // Nomor unik bukti pembayaran
  scheduleId      String // Schedule yang akan dipesan
  customerId      String // Customer yang upload
  bookerPhone     String // Nomor HP pemesan
  pickupAddress   String // Alamat jemput
  dropoffAddress  String // Alamat antar
  totalPassengers Int // Jumlah penumpang
  totalPrice      Int // Total harga yang harus dibayar
  paymentProofUrl String // URL file bukti pembayaran
  status          PaymentProofStatus @default(PENDING)
  notes           String? // Catatan dari customer

  // Approval fields
  reviewedBy      String? // Admin yang review
  reviewedAt      DateTime? // Kapan direview
  rejectionReason String? // Alasan jika ditolak

  // Ticket reference (jika approved)
  ticketId String? @unique // Tiket yang dibuat setelah approve

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schedule   Schedule                @relation(fields: [scheduleId], references: [id], onDelete: Restrict)
  customer   Customer                @relation(fields: [customerId], references: [id], onDelete: Restrict)
  ticket     Ticket?                 @relation(fields: [ticketId], references: [id], onDelete: SetNull)
  passengers PaymentProofPassenger[] // Data penumpang

  @@index([proofNumber])
  @@index([scheduleId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@index([reviewedBy])
}

model PaymentProofPassenger {
  id             String   @id @default(uuid())
  paymentProofId String
  name           String
  identityNumber String? // NIK/KTP/Passport
  phone          String?
  seatNumber     String? // Nomor kursi yang diinginkan
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  paymentProof PaymentProof @relation(fields: [paymentProofId], references: [id], onDelete: Cascade)

  @@index([paymentProofId])
}

// ==================== TRAVEL DOCUMENT (SURAT JALAN) ====================

enum TravelDocumentStatus {
  DRAFT
  ISSUED
  CANCELLED
}

model TravelDocument {
  id              String               @id @default(uuid())
  documentNumber  String               @unique // Nomor surat jalan
  scheduleId      String
  vehicleId       String
  adminId         String // Admin yang menerbitkan
  driverName      String
  driverPhone     String
  totalPassengers Int
  departureDate   DateTime
  status          TravelDocumentStatus @default(DRAFT)
  issuedAt        DateTime? // Kapan diterbitkan
  notes           String?
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelReason    String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Restrict)
  vehicle  Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  admin    Admin    @relation(fields: [adminId], references: [id], onDelete: Restrict)

  @@index([documentNumber])
  @@index([scheduleId])
  @@index([vehicleId])
  @@index([adminId])
  @@index([status])
  @@index([departureDate])
  @@index([cancelledAt])
}

// ==================== TRIP LOG (DRIVER TRACKING) ====================

enum TripStatus {
  ASSIGNED // Trip sudah di-assign ke driver
  READY // Driver ready untuk berangkat
  DEPARTED // Trip sudah berangkat
  IN_TRANSIT // Dalam perjalanan
  REST_STOP // Berhenti istirahat
  ARRIVED // Sudah sampai tujuan
  COMPLETED // Trip selesai
  CANCELLED // Trip dibatalkan
}

model TripLog {
  id         String     @id @default(uuid())
  scheduleId String
  driverId   String
  status     TripStatus
  location   String? // Lokasi saat update (opsional)
  latitude   Float? // GPS latitude
  longitude  Float? // GPS longitude
  notes      String? // Catatan dari driver
  timestamp  DateTime   @default(now())

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  driver   Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([driverId])
  @@index([status])
  @@index([timestamp])
}

// ==================== SYSTEM CONFIGURATION ====================

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ==================== TOKEN BLACKLIST ====================

model TokenBlacklist {
  id        String   @id @default(uuid())
  token     String   @unique // JWT token yang di-blacklist
  userId    String // User yang logout
  expiresAt DateTime // Waktu expired token (untuk auto cleanup)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ==================== OTP VERIFICATION ====================

enum OtpType {
  REGISTRATION // OTP untuk registrasi
  PASSWORD_RESET // OTP untuk reset password
  PHONE_VERIFICATION // OTP untuk verifikasi nomor HP
}

enum OtpStatus {
  PENDING // Menunggu verifikasi
  VERIFIED // Sudah diverifikasi
  EXPIRED // Sudah kadaluarsa
  FAILED // Gagal (max attempts exceeded)
}

model Otp {
  id          String    @id @default(uuid())
  phone       String // Nomor HP tujuan
  code        String // Kode OTP (6 digit)
  type        OtpType // Jenis OTP
  status      OtpStatus @default(PENDING)
  attempts    Int       @default(0) // Jumlah percobaan verifikasi
  maxAttempts Int       @default(3) // Maksimal percobaan
  expiresAt   DateTime // Waktu kadaluarsa (default 5 menit)
  verifiedAt  DateTime? // Waktu verifikasi berhasil
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([phone])
  @@index([code])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
}
